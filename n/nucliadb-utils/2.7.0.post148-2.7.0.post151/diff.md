# Comparing `tmp/nucliadb_utils-2.7.0.post148-py3-none-any.whl.zip` & `tmp/nucliadb_utils-2.7.0.post151-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,71 +1,70 @@
-Zip file size: 96905 bytes, number of entries: 69
--rw-r--r--  2.0 unx      895 b- defN 23-Apr-11 09:54 nucliadb_utils/__init__.py
--rw-r--r--  2.0 unx     5877 b- defN 23-Apr-11 09:54 nucliadb_utils/authentication.py
--rw-r--r--  2.0 unx     4518 b- defN 23-Apr-11 09:54 nucliadb_utils/clandestined.py
--rw-r--r--  2.0 unx     1090 b- defN 23-Apr-11 09:54 nucliadb_utils/exceptions.py
--rw-r--r--  2.0 unx     1869 b- defN 23-Apr-11 09:54 nucliadb_utils/featureflagging.py
--rw-r--r--  2.0 unx     2212 b- defN 23-Apr-11 09:54 nucliadb_utils/grpc.py
--rw-r--r--  2.0 unx     3572 b- defN 23-Apr-11 09:54 nucliadb_utils/indexing.py
--rw-r--r--  2.0 unx      867 b- defN 23-Apr-11 09:54 nucliadb_utils/keys.py
--rw-r--r--  2.0 unx     1519 b- defN 23-Apr-11 09:54 nucliadb_utils/nats.py
--rw-r--r--  2.0 unx     1173 b- defN 23-Apr-11 09:54 nucliadb_utils/partition.py
--rw-r--r--  2.0 unx        0 b- defN 23-Apr-11 09:54 nucliadb_utils/py.typed
--rw-r--r--  2.0 unx     1713 b- defN 23-Apr-11 09:54 nucliadb_utils/run.py
--rw-r--r--  2.0 unx     4451 b- defN 23-Apr-11 09:54 nucliadb_utils/settings.py
--rw-r--r--  2.0 unx     1337 b- defN 23-Apr-11 09:54 nucliadb_utils/settings_running.py
--rw-r--r--  2.0 unx      890 b- defN 23-Apr-11 09:54 nucliadb_utils/store.py
--rw-r--r--  2.0 unx     6633 b- defN 23-Apr-11 09:54 nucliadb_utils/transaction.py
--rw-r--r--  2.0 unx     9972 b- defN 23-Apr-11 09:54 nucliadb_utils/utilities.py
--rw-r--r--  2.0 unx      835 b- defN 23-Apr-11 09:54 nucliadb_utils/audit/__init__.py
--rw-r--r--  2.0 unx     2013 b- defN 23-Apr-11 09:54 nucliadb_utils/audit/audit.py
--rw-r--r--  2.0 unx     2446 b- defN 23-Apr-11 09:54 nucliadb_utils/audit/basic.py
--rw-r--r--  2.0 unx     7688 b- defN 23-Apr-11 09:54 nucliadb_utils/audit/stream.py
--rw-r--r--  2.0 unx      900 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/__init__.py
--rw-r--r--  2.0 unx      975 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/exceptions.py
--rw-r--r--  2.0 unx     1216 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/memcache.py
--rw-r--r--  2.0 unx     6776 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/nats.py
--rw-r--r--  2.0 unx     1654 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/pubsub.py
--rw-r--r--  2.0 unx     3110 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/redis.py
--rw-r--r--  2.0 unx     1302 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/settings.py
--rw-r--r--  2.0 unx     5906 b- defN 23-Apr-11 09:54 nucliadb_utils/cache/utility.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 09:54 nucliadb_utils/fastapi/__init__.py
--rw-r--r--  2.0 unx     1316 b- defN 23-Apr-11 09:54 nucliadb_utils/fastapi/metrics.py
--rw-r--r--  2.0 unx     1737 b- defN 23-Apr-11 09:54 nucliadb_utils/fastapi/openapi.py
--rw-r--r--  2.0 unx     3888 b- defN 23-Apr-11 09:54 nucliadb_utils/fastapi/run.py
--rw-r--r--  2.0 unx     3786 b- defN 23-Apr-11 09:54 nucliadb_utils/fastapi/versioning.py
--rw-r--r--  2.0 unx      855 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/__init__.py
--rw-r--r--  2.0 unx     2165 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/exceptions.py
--rw-r--r--  2.0 unx    24772 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/gcs.py
--rw-r--r--  2.0 unx    10180 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/local.py
--rw-r--r--  2.0 unx     2093 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/nuclia.py
--rw-r--r--  2.0 unx    17174 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/pg.py
--rw-r--r--  2.0 unx    15029 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/s3.py
--rw-r--r--  2.0 unx     1276 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/settings.py
--rw-r--r--  2.0 unx    16412 b- defN 23-Apr-11 09:54 nucliadb_utils/storages/storage.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/__init__.py
--rw-r--r--  2.0 unx    10691 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/asyncbenchmark.py
--rw-r--r--  2.0 unx     1043 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/clandestined.py
--rw-r--r--  2.0 unx     1686 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/conftest.py
--rw-r--r--  2.0 unx     2758 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/gcs.py
--rw-r--r--  2.0 unx     2307 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/indexing.py
--rw-r--r--  2.0 unx     1310 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/local.py
--rw-r--r--  2.0 unx     7697 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/nats.py
--rw-r--r--  2.0 unx     2216 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/s3.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/__init__.py
--rw-r--r--  2.0 unx     5159 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_authentication.py
--rw-r--r--  2.0 unx    14507 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_clandestined.py
--rw-r--r--  2.0 unx     1949 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_clandestined_collision.py
--rw-r--r--  2.0 unx     5303 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
--rw-r--r--  2.0 unx     1910 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_run.py
--rw-r--r--  2.0 unx     1189 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_tests.py
--rw-r--r--  2.0 unx     1667 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_transaction.py
--rw-r--r--  2.0 unx     4436 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/test_utilities.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/storages/__init__.py
--rw-r--r--  2.0 unx    16726 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/storages/test_pg.py
--rw-r--r--  2.0 unx     4943 b- defN 23-Apr-11 09:54 nucliadb_utils/tests/unit/storages/test_storage.py
--rw-r--r--  2.0 unx     1924 b- defN 23-Apr-11 09:56 nucliadb_utils-2.7.0.post148.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Apr-11 09:56 nucliadb_utils-2.7.0.post148.dist-info/WHEEL
--rw-r--r--  2.0 unx       15 b- defN 23-Apr-11 09:56 nucliadb_utils-2.7.0.post148.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 23-Apr-11 09:55 nucliadb_utils-2.7.0.post148.dist-info/zip-safe
--rw-rw-r--  2.0 unx     6213 b- defN 23-Apr-11 09:56 nucliadb_utils-2.7.0.post148.dist-info/RECORD
-69 files, 283166 bytes uncompressed, 86945 bytes compressed:  69.3%
+Zip file size: 96495 bytes, number of entries: 68
+-rw-r--r--  2.0 unx      895 b- defN 23-Apr-11 16:33 nucliadb_utils/__init__.py
+-rw-r--r--  2.0 unx     5877 b- defN 23-Apr-11 16:33 nucliadb_utils/authentication.py
+-rw-r--r--  2.0 unx     4518 b- defN 23-Apr-11 16:33 nucliadb_utils/clandestined.py
+-rw-r--r--  2.0 unx     1090 b- defN 23-Apr-11 16:33 nucliadb_utils/exceptions.py
+-rw-r--r--  2.0 unx     1869 b- defN 23-Apr-11 16:33 nucliadb_utils/featureflagging.py
+-rw-r--r--  2.0 unx     2212 b- defN 23-Apr-11 16:33 nucliadb_utils/grpc.py
+-rw-r--r--  2.0 unx     3572 b- defN 23-Apr-11 16:33 nucliadb_utils/indexing.py
+-rw-r--r--  2.0 unx      867 b- defN 23-Apr-11 16:33 nucliadb_utils/keys.py
+-rw-r--r--  2.0 unx     1519 b- defN 23-Apr-11 16:33 nucliadb_utils/nats.py
+-rw-r--r--  2.0 unx     1173 b- defN 23-Apr-11 16:33 nucliadb_utils/partition.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Apr-11 16:33 nucliadb_utils/py.typed
+-rw-r--r--  2.0 unx     1713 b- defN 23-Apr-11 16:33 nucliadb_utils/run.py
+-rw-r--r--  2.0 unx     4649 b- defN 23-Apr-11 16:33 nucliadb_utils/settings.py
+-rw-r--r--  2.0 unx      890 b- defN 23-Apr-11 16:33 nucliadb_utils/store.py
+-rw-r--r--  2.0 unx     6633 b- defN 23-Apr-11 16:33 nucliadb_utils/transaction.py
+-rw-r--r--  2.0 unx     9972 b- defN 23-Apr-11 16:33 nucliadb_utils/utilities.py
+-rw-r--r--  2.0 unx      835 b- defN 23-Apr-11 16:33 nucliadb_utils/audit/__init__.py
+-rw-r--r--  2.0 unx     2013 b- defN 23-Apr-11 16:33 nucliadb_utils/audit/audit.py
+-rw-r--r--  2.0 unx     2446 b- defN 23-Apr-11 16:33 nucliadb_utils/audit/basic.py
+-rw-r--r--  2.0 unx     7688 b- defN 23-Apr-11 16:33 nucliadb_utils/audit/stream.py
+-rw-r--r--  2.0 unx      900 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/__init__.py
+-rw-r--r--  2.0 unx      975 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/exceptions.py
+-rw-r--r--  2.0 unx     1216 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/memcache.py
+-rw-r--r--  2.0 unx     6776 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/nats.py
+-rw-r--r--  2.0 unx     1654 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/pubsub.py
+-rw-r--r--  2.0 unx     3110 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/redis.py
+-rw-r--r--  2.0 unx     1302 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/settings.py
+-rw-r--r--  2.0 unx     5906 b- defN 23-Apr-11 16:33 nucliadb_utils/cache/utility.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 16:33 nucliadb_utils/fastapi/__init__.py
+-rw-r--r--  2.0 unx     1308 b- defN 23-Apr-11 16:33 nucliadb_utils/fastapi/metrics.py
+-rw-r--r--  2.0 unx     1737 b- defN 23-Apr-11 16:33 nucliadb_utils/fastapi/openapi.py
+-rw-r--r--  2.0 unx     3880 b- defN 23-Apr-11 16:33 nucliadb_utils/fastapi/run.py
+-rw-r--r--  2.0 unx     3786 b- defN 23-Apr-11 16:33 nucliadb_utils/fastapi/versioning.py
+-rw-r--r--  2.0 unx      855 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/__init__.py
+-rw-r--r--  2.0 unx     2274 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/exceptions.py
+-rw-r--r--  2.0 unx    24772 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/gcs.py
+-rw-r--r--  2.0 unx    10180 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/local.py
+-rw-r--r--  2.0 unx     2093 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/nuclia.py
+-rw-r--r--  2.0 unx    17174 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/pg.py
+-rw-r--r--  2.0 unx    15029 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/s3.py
+-rw-r--r--  2.0 unx     1276 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/settings.py
+-rw-r--r--  2.0 unx    17421 b- defN 23-Apr-11 16:33 nucliadb_utils/storages/storage.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/__init__.py
+-rw-r--r--  2.0 unx    10691 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/asyncbenchmark.py
+-rw-r--r--  2.0 unx     1043 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/clandestined.py
+-rw-r--r--  2.0 unx     1686 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/conftest.py
+-rw-r--r--  2.0 unx     2758 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/gcs.py
+-rw-r--r--  2.0 unx     2307 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/indexing.py
+-rw-r--r--  2.0 unx     1310 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/local.py
+-rw-r--r--  2.0 unx     7697 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/nats.py
+-rw-r--r--  2.0 unx     2216 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/s3.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/__init__.py
+-rw-r--r--  2.0 unx     5159 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_authentication.py
+-rw-r--r--  2.0 unx    14507 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_clandestined.py
+-rw-r--r--  2.0 unx     1949 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_clandestined_collision.py
+-rw-r--r--  2.0 unx     5303 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
+-rw-r--r--  2.0 unx     1910 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_run.py
+-rw-r--r--  2.0 unx     1189 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_tests.py
+-rw-r--r--  2.0 unx     1667 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_transaction.py
+-rw-r--r--  2.0 unx     4436 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/test_utilities.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/storages/__init__.py
+-rw-r--r--  2.0 unx    16726 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/storages/test_pg.py
+-rw-r--r--  2.0 unx     5638 b- defN 23-Apr-11 16:33 nucliadb_utils/tests/unit/storages/test_storage.py
+-rw-r--r--  2.0 unx     1924 b- defN 23-Apr-11 16:35 nucliadb_utils-2.7.0.post151.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-11 16:35 nucliadb_utils-2.7.0.post151.dist-info/WHEEL
+-rw-r--r--  2.0 unx       15 b- defN 23-Apr-11 16:35 nucliadb_utils-2.7.0.post151.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 23-Apr-11 16:34 nucliadb_utils-2.7.0.post151.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     6122 b- defN 23-Apr-11 16:35 nucliadb_utils-2.7.0.post151.dist-info/RECORD
+68 files, 283733 bytes uncompressed, 86679 bytes compressed:  69.5%
```

## zipnote {}

```diff
@@ -33,17 +33,14 @@
 
 Filename: nucliadb_utils/run.py
 Comment: 
 
 Filename: nucliadb_utils/settings.py
 Comment: 
 
-Filename: nucliadb_utils/settings_running.py
-Comment: 
-
 Filename: nucliadb_utils/store.py
 Comment: 
 
 Filename: nucliadb_utils/transaction.py
 Comment: 
 
 Filename: nucliadb_utils/utilities.py
@@ -186,23 +183,23 @@
 
 Filename: nucliadb_utils/tests/unit/storages/test_pg.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/storages/test_storage.py
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post148.dist-info/METADATA
+Filename: nucliadb_utils-2.7.0.post151.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post148.dist-info/WHEEL
+Filename: nucliadb_utils-2.7.0.post151.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post148.dist-info/top_level.txt
+Filename: nucliadb_utils-2.7.0.post151.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post148.dist-info/zip-safe
+Filename: nucliadb_utils-2.7.0.post151.dist-info/zip-safe
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post148.dist-info/RECORD
+Filename: nucliadb_utils-2.7.0.post151.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_utils/settings.py

```diff
@@ -15,26 +15,32 @@
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
 from typing import Dict, List, Optional
 
-from pydantic import BaseSettings
+from pydantic import BaseSettings, Field
 from pydantic.class_validators import root_validator
 
 
 class RunningSettings(BaseSettings):
     debug: bool = True
     sentry_url: Optional[str] = None
-    running_environment: str = "local"
+    running_environment: str = Field(
+        "local", env=["environment", "running_environment"]
+    )
     logging_integration: bool = False
     log_level: str = "DEBUG"
     activity_log_level: str = "INFO"
     chitchat_level: str = "INFO"
+    metrics_port: int = 3030
+    metrics_host: str = "0.0.0.0"
+    serving_port: int = 8080
+    serving_host: str = "0.0.0.0"
 
 
 running_settings = RunningSettings()
 
 
 class HTTPSettings(BaseSettings):
     cors_origins: List[str] = ["http://localhost:4200"]
```

## nucliadb_utils/fastapi/metrics.py

```diff
@@ -17,15 +17,15 @@
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
 import prometheus_client  # type: ignore
 from fastapi import FastAPI
 from starlette.responses import PlainTextResponse
 
-from nucliadb_utils.settings_running import running_settings
+from nucliadb_utils.settings import running_settings
 
 
 async def metrics(request):
     output = prometheus_client.exposition.generate_latest()
     return PlainTextResponse(output.decode("utf8"))
```

## nucliadb_utils/fastapi/run.py

```diff
@@ -24,15 +24,15 @@
 import click
 from fastapi import FastAPI
 from uvicorn.config import Config  # type: ignore
 from uvicorn.server import Server  # type: ignore
 
 from nucliadb_utils import logger
 from nucliadb_utils.fastapi.metrics import application_metrics
-from nucliadb_utils.settings_running import running_settings
+from nucliadb_utils.settings import running_settings
 
 STARTUP_FAILURE = 3
 
 
 def metrics_app() -> tuple[Server, Config]:
     loop_setup = "auto"
     log_level = running_settings.log_level.lower()
```

## nucliadb_utils/storages/exceptions.py

```diff
@@ -60,7 +60,13 @@
         self.text = text
         super().__init__(
             f"Could not copy file {self.origin_bucket_name}:{self.origin_uri}"
             f"To {self.destination_bucket_name}:{self.destination_uri}"
             "Google: \n "
             f"{text}"
         )
+
+
+class IndexDataNotFound(Exception):
+    """
+    Raised when the index data is not found in storage
+    """
```

## nucliadb_utils/storages/storage.py

```diff
@@ -18,34 +18,45 @@
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 #
 from __future__ import annotations
 
 import abc
 import hashlib
 from io import BytesIO
-from typing import Any, AsyncGenerator, AsyncIterator, Dict, List, Optional, Tuple, Type
+from typing import (
+    Any,
+    AsyncGenerator,
+    AsyncIterator,
+    Dict,
+    List,
+    Optional,
+    Tuple,
+    Type,
+    Union,
+)
 
 from nucliadb_protos.noderesources_pb2 import Resource as BrainResource
 from nucliadb_protos.nodewriter_pb2 import IndexMessage, TypeMessage
 from nucliadb_protos.resources_pb2 import CloudFile
 from nucliadb_protos.writer_pb2 import BrokerMessage
 
 from nucliadb_utils import logger
 from nucliadb_utils.storages import CHUNK_SIZE
-from nucliadb_utils.storages.exceptions import InvalidCloudFile
+from nucliadb_utils.storages.exceptions import IndexDataNotFound, InvalidCloudFile
 from nucliadb_utils.utilities import get_local_storage, get_nuclia_storage
 
 STORAGE_RESOURCE = "kbs/{kbid}/r/{uuid}"
 KB_RESOURCE_FIELD = "kbs/{kbid}/r/{uuid}/f/f/{field}"
 KB_LAYOUT_FIELD = "kbs/{kbid}/r/{uuid}/f/l/{field}/{ident}"
 KB_CONVERSATION_FIELD = "kbs/{kbid}/r/{uuid}/f/c/{field}/{ident}/{count}"
 STORAGE_FILE_EXTRACTED = "kbs/{kbid}/r/{uuid}/e/{field_type}/{field}/{key}"
 
 DEADLETTER = "deadletter/{partition}/{seqid}/{seq}"
-INDEXING = "index/{node}/{shard}/{txid}"
+OLD_INDEXING_KEY = "index/{node}/{shard}/{txid}"
+INDEXING_KEY = "index/{kb}/{shard}/{resource}/{txid}"
 
 
 class StorageField:
     storage: Storage
     bucket: str
     key: str
     field: Optional[CloudFile] = None
@@ -136,93 +147,127 @@
     ):
         if self.deadletter_bucket is None:
             logger.error("No Deadletter Bucket defined will not store the error")
             return
         key = DEADLETTER.format(seqid=seqid, seq=seq, partition=partition)
         await self.uploadbytes(self.deadletter_bucket, key, message.SerializeToString())
 
+    def get_indexing_storage_key(
+        self, *, kb: str, logical_shard: str, resource_uid: str, txid: Union[int, str]
+    ):
+        return INDEXING_KEY.format(
+            kb=kb, shard=logical_shard, resource=resource_uid, txid=txid
+        )
+
     async def indexing(
         self,
         message: BrainResource,
-        node: str,
-        shard: str,
         txid: int,
         partition: Optional[str],
+        kb: str,
+        logical_shard: str,
     ) -> IndexMessage:
         if self.indexing_bucket is None:
             raise AttributeError()
         if txid < 0:
             txid = 0
-        key = INDEXING.format(node=node, shard=shard, txid=txid)
+
+        key = self.get_indexing_storage_key(
+            kb=kb,
+            logical_shard=logical_shard,
+            resource_uid=message.resource.uuid,
+            txid=txid,
+        )
         await self.uploadbytes(self.indexing_bucket, key, message.SerializeToString())
         response = IndexMessage()
-        response.node = node
-        response.shard = shard
         response.txid = txid
         response.typemessage = TypeMessage.CREATION
+        response.storage_key = key
         if partition:
             response.partition = partition
         return response
 
     async def reindexing(
         self,
         message: BrainResource,
-        node: str,
-        shard: str,
         reindex_id: str,
         partition: Optional[str],
+        kb: str,
+        logical_shard: str,
     ) -> IndexMessage:
         if self.indexing_bucket is None:
             raise AttributeError()
-        key = INDEXING.format(node=node, shard=shard, txid=reindex_id)
+        key = self.get_indexing_storage_key(
+            kb=kb,
+            logical_shard=logical_shard,
+            resource_uid=message.resource.uuid,
+            txid=reindex_id,
+        )
         logger.info("Starting to serialize message")
         message_serialized = message.SerializeToString()
         logger.info("Starting to upload bytes")
         await self.uploadbytes(self.indexing_bucket, key, message_serialized)
         logger.info("Finished to upload bytes")
         response = IndexMessage()
-        response.node = node
-        response.shard = shard
         response.reindex_id = reindex_id
         response.typemessage = TypeMessage.CREATION
+        response.storage_key = key
         if partition:
             response.partition = partition
         return response
 
     async def get_indexing(self, payload: IndexMessage) -> BrainResource:
         if self.indexing_bucket is None:
             raise AttributeError()
-        if payload.txid == 0:
-            key = INDEXING.format(
-                node=payload.node, shard=payload.shard, txid=payload.reindex_id
-            )
+        if payload.storage_key:
+            key = payload.storage_key
         else:
-            key = INDEXING.format(
-                node=payload.node, shard=payload.shard, txid=payload.txid
-            )
+            # b/w compatibility
+            if payload.txid == 0:
+                key = OLD_INDEXING_KEY.format(
+                    node=payload.node,
+                    shard=payload.shard,
+                    txid=payload.reindex_id,
+                )
+            else:
+                key = OLD_INDEXING_KEY.format(
+                    node=payload.node, shard=payload.shard, txid=payload.txid
+                )
+
         bytes_buffer = await self.downloadbytes(self.indexing_bucket, key)
         if bytes_buffer.getbuffer().nbytes == 0:
-            raise KeyError()
+            raise IndexDataNotFound(f'Indexing data not found for key "{key}"')
         pb = BrainResource()
         pb.ParseFromString(bytes_buffer.read())
         bytes_buffer.flush()
         return pb
 
-    async def delete_indexing(self, payload: IndexMessage):
+    async def delete_indexing(
+        self,
+        resource_uid: str,
+        txid: int,
+        kb: str,
+        logical_shard: str,
+    ):
         if self.indexing_bucket is None:
             raise AttributeError()
 
-        if payload.txid == 0 and payload.reindex_id != "":
-            # Deleting a reindexing payload
-            txid = payload.reindex_id
-        else:
-            txid = str(payload.txid)
+        # write out empty data but use the .deleted suffix
+        # so we know by the key that it was deleted
+        key = (
+            self.get_indexing_storage_key(
+                kb=kb,
+                logical_shard=logical_shard,
+                resource_uid=resource_uid,
+                txid=txid,
+            )
+            + ".deleted"
+        )
 
-        key = INDEXING.format(node=payload.node, shard=payload.shard, txid=txid)
-        await self.delete_upload(key, self.indexing_bucket)
+        await self.uploadbytes(self.indexing_bucket, key, b"")
 
     def needs_move(self, file: CloudFile, kbid: str) -> bool:
         # The cloudfile is valid for our environment
         if file.uri == "":
             return False
         elif (
             file.source == self.source
```

## nucliadb_utils/tests/unit/storages/test_storage.py

```diff
@@ -17,14 +17,15 @@
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
 from unittest.mock import AsyncMock, MagicMock
 
 import pytest
 from nucliadb_protos.noderesources_pb2 import Resource as BrainResource
+from nucliadb_protos.noderesources_pb2 import ResourceID
 from nucliadb_protos.nodewriter_pb2 import IndexMessage
 from nucliadb_protos.resources_pb2 import CloudFile
 
 from nucliadb_utils.storages.storage import Storage, StorageField
 
 
 class TestStorageField:
@@ -83,47 +84,58 @@
     async def test_delete_resource(self, storage: StorageTest):
         await storage.delete_resource("bucket", "uri")
 
         storage.delete_upload.assert_called_once_with("uri", "bucket")
 
     @pytest.mark.asyncio
     async def test_indexing(self, storage: StorageTest):
-        msg = BrainResource()
-        await storage.indexing(msg, "node", "shard", 1, "1")
+        msg = BrainResource(resource=ResourceID(uuid="uuid"))
+        await storage.indexing(msg, 1, "1", "kb", "shard")
 
         storage.uploadbytes.assert_called_once_with(
-            "indexing_bucket", "index/node/shard/1", msg.SerializeToString()
+            "indexing_bucket", "index/kb/shard/uuid/1", msg.SerializeToString()
         )
 
     @pytest.mark.asyncio
     async def test_reindexing(self, storage: StorageTest):
-        msg = BrainResource()
-        await storage.reindexing(msg, "node", "shard", "reindex_id", "1")
+        msg = BrainResource(resource=ResourceID(uuid="uuid"))
+        await storage.reindexing(msg, "reindex_id", "1", "kb", "shard")
 
         storage.uploadbytes.assert_called_once_with(
-            "indexing_bucket", "index/node/shard/reindex_id", msg.SerializeToString()
+            "indexing_bucket", "index/kb/shard/uuid/reindex_id", msg.SerializeToString()
         )
 
     @pytest.mark.asyncio
     async def test_get_indexing(self, storage: StorageTest):
         im = IndexMessage()
         im.node = "node"
         im.shard = "shard"
         im.txid = 0
         assert isinstance(await storage.get_indexing(im), BrainResource)
 
     @pytest.mark.asyncio
-    async def test_delete_indexing(self, storage: StorageTest):
+    async def test_get_indexing_storage_key(self, storage: StorageTest):
         im = IndexMessage()
         im.node = "node"
         im.shard = "shard"
         im.txid = 0
-        await storage.delete_indexing(im)
+        im.storage_key = "index/kb/uuid/1"
+        assert isinstance(await storage.get_indexing(im), BrainResource)
+
+    @pytest.mark.asyncio
+    async def test_delete_indexing(self, storage: StorageTest):
+        im = IndexMessage()
+        im.node = "node"
+        im.txid = 0
+        im.storage_key = "index/kb/uuid/1"
+        await storage.delete_indexing(
+            resource_uid="resource_uid", txid=1, kb="kb", logical_shard="logical_shard"
+        )
 
-        storage.delete_upload.assert_called_once()
+        storage.uploadbytes.assert_called_once()
 
     @pytest.mark.asyncio
     async def test_download_pb(self, storage: StorageTest):
         assert isinstance(
             await storage.download_pb(
                 StorageField(storage, "bucket", "fullkey"), BrainResource
             ),
@@ -133,17 +145,22 @@
     @pytest.mark.asyncio
     async def test_indexing_bucket_none_attributeerrror(self, storage: StorageTest):
         storage.indexing_bucket = None
         msg = BrainResource()
         im = IndexMessage(node="node", shard="shard", txid=0)
 
         with pytest.raises(AttributeError):
-            await storage.indexing(msg, "node", "shard", 1, "1")
+            await storage.indexing(msg, 1, "1", "kb", "shard")
 
         with pytest.raises(AttributeError):
-            await storage.reindexing(msg, "node", "shard", "reindex_id", "1")
+            await storage.reindexing(msg, "reindex_id", "1", "kb", "shard")
 
         with pytest.raises(AttributeError):
             await storage.get_indexing(im)
 
         with pytest.raises(AttributeError):
-            await storage.delete_indexing(im)
+            await storage.delete_indexing(
+                resource_uid="resource_uid",
+                txid=1,
+                kb="kb",
+                logical_shard="logical_shard",
+            )
```

## Comparing `nucliadb_utils-2.7.0.post148.dist-info/METADATA` & `nucliadb_utils-2.7.0.post151.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-utils
-Version: 2.7.0.post148
+Version: 2.7.0.post151
 Summary: UNKNOWN
 Home-page: https://nuclia.com
 License: BSD
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
@@ -12,15 +12,15 @@
 Requires-Dist: aiohttp (>=3.8.1)
 Requires-Dist: prometheus-client (>=0.12.0)
 Requires-Dist: types-requests (>=2.27.7)
 Requires-Dist: mmh3 (>=3.0.0)
 Requires-Dist: nats-py[nkeys] (>=2.1.3)
 Requires-Dist: pyjwt (>=2.4.0)
 Requires-Dist: memorylru (>=1.1.2)
-Requires-Dist: nucliadb-protos (==2.7.0-post148)
+Requires-Dist: nucliadb-protos (==2.7.0-post151)
 Requires-Dist: nucliadb-telemetry (>=1.8.0)
 Requires-Dist: mrflagly
 Provides-Extra: cache
 Requires-Dist: redis (>=4.3.4) ; extra == 'cache'
 Requires-Dist: orjson (>=3.6.7) ; extra == 'cache'
 Requires-Dist: lru-dict (>=1.1.7) ; extra == 'cache'
 Provides-Extra: fastapi
```

## Comparing `nucliadb_utils-2.7.0.post148.dist-info/RECORD` & `nucliadb_utils-2.7.0.post151.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -6,16 +6,15 @@
 nucliadb_utils/grpc.py,sha256=DJE9tQDvjUiiyF43F3Bsl5tfXmjO49l89IETfBOgCIo,2212
 nucliadb_utils/indexing.py,sha256=JSyNSzAbYthomDI2hvr9KaH9nGE7IURPZA0wAUNnzSc,3572
 nucliadb_utils/keys.py,sha256=fjumJHFoRaTbasLO5jZJ46xacAy-HqYAN-8Oquup75o,867
 nucliadb_utils/nats.py,sha256=YW4uMrgL0Ih3SMd5Yo_kHZtas86WXrKo-Nb7HQjEPR4,1519
 nucliadb_utils/partition.py,sha256=0tmXuwRM_v-OmKoRkB--OMDzomVEkmgxqMmNNomI_24,1173
 nucliadb_utils/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nucliadb_utils/run.py,sha256=bKMfsPEK6WdWfiPyWPUxCqcLo4tq6eOwyaf910TOwBk,1713
-nucliadb_utils/settings.py,sha256=odBjp1fuf3qFC6psEWydX8e2C_bZwXNMK4oq2UE1jAM,4451
-nucliadb_utils/settings_running.py,sha256=zCqvq6XsHxDrF_3bWd2m-iYLefPznvqQkBX33WfdeSk,1337
+nucliadb_utils/settings.py,sha256=23v5-fKtxXxrqJiC2JRIRRMLLBMrvjg3RhOnQ-xJbok,4649
 nucliadb_utils/store.py,sha256=kQ35HemE0v4_Qg6xVqNIJi8vSFAYQtwI3rDtMsNy62Y,890
 nucliadb_utils/transaction.py,sha256=l5nbx-GMZvB79rrF2aikvI9yhYHq3WEed4cvFYtW9V8,6633
 nucliadb_utils/utilities.py,sha256=TGXbI8zVxcf8eeabF22TOMD4qwM_SpHpkb_I7HamUqI,9972
 nucliadb_utils/audit/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
 nucliadb_utils/audit/audit.py,sha256=eZwbTaDHtEAqjtJ34eNuBtv05tK6XfcfcxWeGgOl4Z4,2013
 nucliadb_utils/audit/basic.py,sha256=V6bYvJqP9cvagrvnrYaym0aKpictP0XvL_s34S0YX68,2446
 nucliadb_utils/audit/stream.py,sha256=jZe2VbZ4dR5oRkfOnoOKsmEeQMqcUWMxsjccL7oJCW8,7688
@@ -24,27 +23,27 @@
 nucliadb_utils/cache/memcache.py,sha256=CWd09BLh0K7vmxmj3Bhh0cLlCVeI_uvkzubqJpK7h0A,1216
 nucliadb_utils/cache/nats.py,sha256=TZ2naqcLMwP9Pkzxt1fEQ55km4iPKn9mJjhYXpHR62E,6776
 nucliadb_utils/cache/pubsub.py,sha256=l8i_RwRf7OPzfmPy-gyn66xgYFs5aHidCIjEaU9VOHE,1654
 nucliadb_utils/cache/redis.py,sha256=EvtfbZgBDwDMgZNeHCsfJylFWlHFTp8NdC3zQHzHfEc,3110
 nucliadb_utils/cache/settings.py,sha256=CP4YsCYQUFC3ki_i-54qoMZX-Iup53nrT1V9NIg05RE,1302
 nucliadb_utils/cache/utility.py,sha256=N_3BjomLEEmoZ3ieGWsRZXuwrhLK-qqH8mF0UsldjF0,5906
 nucliadb_utils/fastapi/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
-nucliadb_utils/fastapi/metrics.py,sha256=7cfOKdAYtYMZ-n62Hui-SOfBRnBVQht363f2AfUI6qc,1316
+nucliadb_utils/fastapi/metrics.py,sha256=Jc_Q3cOjIGlf1bF3HW3fi9VHrQX3KVXdPpsoU48IsmY,1308
 nucliadb_utils/fastapi/openapi.py,sha256=b0pLuri0QuzQd0elDyOVXM42YYmES_cmT-jEfsQ1G6Y,1737
-nucliadb_utils/fastapi/run.py,sha256=eG-Ttvl0Ii6BlHQkTnCEXPZwlMzQK3LIV-7IVfUvvJw,3888
+nucliadb_utils/fastapi/run.py,sha256=Jl0C8ij_pY8mdRB1flPfiaftJuS3-1jEclQorY8jPI0,3880
 nucliadb_utils/fastapi/versioning.py,sha256=yzHG_TS8ga-qXum6op2dZUxDrVr_zBjAu6LNz28Elao,3786
 nucliadb_utils/storages/__init__.py,sha256=WOSaQhFBQ_TePebZa1nCy_MJAI61ioY_52P9x8LG4SI,855
-nucliadb_utils/storages/exceptions.py,sha256=B4rAjJSjnrcKbnWQpTi1xCz55uRcOrOuQI-W8-tgInI,2165
+nucliadb_utils/storages/exceptions.py,sha256=CacQzQv65GCpv5xlAgIp8YDozZ4qt_d7_JoWDsQcykU,2274
 nucliadb_utils/storages/gcs.py,sha256=_8p91D50hwNTcv9775FJDZQ3A4PkoQY1ITv_cmaAnFk,24772
 nucliadb_utils/storages/local.py,sha256=BHc3fG_aiKIVujlqKgig9EiCv5HrKzYCbdPhuhTR-Oc,10180
 nucliadb_utils/storages/nuclia.py,sha256=4qYM0sI9uYbURy-cKtWWiU13ojkWsgjZ8Z0V_cvv7Fo,2093
 nucliadb_utils/storages/pg.py,sha256=hvWZOhUJsboIMCvtFaDg4Dl8Mi5hkEBuYvuPFJESLhI,17174
 nucliadb_utils/storages/s3.py,sha256=LShMSeHJVTvS4xYlimFbKZvHQqaCOIJ7Wr1gsc9kJgc,15029
 nucliadb_utils/storages/settings.py,sha256=bUl3D7To-s3OVXPFFF7LwJbEKGF2WvDM14pwqQdkyoQ,1276
-nucliadb_utils/storages/storage.py,sha256=wDxaN4ErTsuzYdr7FYXv7kMBkiMd65Qqz_XafgfjOs0,16412
+nucliadb_utils/storages/storage.py,sha256=lGNSKj1HK9Grc9Kled5j6FlzPIlD-OSo0t_qjiwcMKU,17421
 nucliadb_utils/tests/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/asyncbenchmark.py,sha256=N3JoHpDyy2v-fvvn998cfbm4zFkGiaVkviW4WTiBO48,10691
 nucliadb_utils/tests/clandestined.py,sha256=33LlZprXXxxKKeRpDr3-10QU25_ztB23LFZCio83KVw,1043
 nucliadb_utils/tests/conftest.py,sha256=1eJEW4W8LToegBSrIQbxx64nI9o2xGipvpSKv7_zGsA,1686
 nucliadb_utils/tests/gcs.py,sha256=Pw0Gaza47uVaymn8VQ3Wxz-xhIv5_3twlxLqW8hl18g,2758
 nucliadb_utils/tests/indexing.py,sha256=EfgcUZzKBUlC-aYAE3CR65M7pQkZ0t_G7DdgdTqhz-U,2307
 nucliadb_utils/tests/local.py,sha256=-oh0bHcTopSG84dYuNJo-66ICjil3sYFqEvmWlsSdnk,1310
@@ -57,13 +56,13 @@
 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py,sha256=_H74r3QNKSy-dX6sifC0EpRJIeh1opkDM672UaznXSg,5303
 nucliadb_utils/tests/unit/test_run.py,sha256=VHeojVBj_AfV_uNch9eEi4zCT-O94VKjwb_O-UZgqpA,1910
 nucliadb_utils/tests/unit/test_tests.py,sha256=-YHgVMKJr_3WYwrBj9TnwpVLIkP80PLZpWnvAIYvnz8,1189
 nucliadb_utils/tests/unit/test_transaction.py,sha256=0K09sWCEZ9iFXHYOiPDhS1Vw5F4akyrmboLalwH-B6U,1667
 nucliadb_utils/tests/unit/test_utilities.py,sha256=96pliy7wk1RqA8r7ogsf4_9AE7FRNK6PjTrB5O-_jBw,4436
 nucliadb_utils/tests/unit/storages/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/storages/test_pg.py,sha256=KAIzD3QuJFMRNSSAKz-M5qrO9fJIHYbZfiOOleTgP1c,16726
-nucliadb_utils/tests/unit/storages/test_storage.py,sha256=td_CgoTEmr3j6OnEHe5idLi5JhYlcYHwIhL_19ov9mc,4943
-nucliadb_utils-2.7.0.post148.dist-info/METADATA,sha256=hJ46Hjlq9x2glWjn-Mg7qhHZ7uyy2S54u-j1-39y46E,1924
-nucliadb_utils-2.7.0.post148.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-nucliadb_utils-2.7.0.post148.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
-nucliadb_utils-2.7.0.post148.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-nucliadb_utils-2.7.0.post148.dist-info/RECORD,,
+nucliadb_utils/tests/unit/storages/test_storage.py,sha256=kgZFXc-y_BX3HlcNHERzAkNPhNilXXQawIHBFq_5Q1k,5638
+nucliadb_utils-2.7.0.post151.dist-info/METADATA,sha256=T40P08bUBqAcZDT8QjvQ1vJpoafiHgE5L6WkP9jydQI,1924
+nucliadb_utils-2.7.0.post151.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+nucliadb_utils-2.7.0.post151.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
+nucliadb_utils-2.7.0.post151.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+nucliadb_utils-2.7.0.post151.dist-info/RECORD,,
```

